# Как работает поиск бизнеса в Праге

## Три способа поиска (в порядке приоритета)

### 1. Google Maps API (самый быстрый, но требует API ключ)

**Как работает:**

- Отправляет HTTP запросы к Google Places API
- Получает структурированные JSON данные
- Быстро и надежно, но требует:
  - API ключ
  - Включенный Places API в Google Cloud Console
  - Оплата после бесплатного лимита

**Что получаем:**

- Название бизнеса
- Адрес
- Телефон
- Веб-сайт
- Рейтинг и отзывы
- Координаты

**Код:** `utils/lead_generation/google_maps_api_client.py`

---

### 2. MCP Google Maps (через MCP сервер)

**Как работает:**

- Использует Model Context Protocol (MCP) сервер
- Обертка над Google Maps API
- Требует настройки MCP сервера

**Код:** `utils/lead_generation/mcp_google_maps.py`

---

### 3. Браузерный скрапер (работает БЕЗ API ключа!)

**Как работает:**

#### Шаг 1: Открытие Google Maps в браузере

```python
# Создается URL поиска
url = f"https://www.google.com/maps/search/{query} {location}"
# Например: https://www.google.com/maps/search/kadeřnictví Prague
```

#### Шаг 2: Загрузка страницы через Playwright

- Запускается браузер Chromium (headless режим)
- Открывается страница Google Maps
- Ждем загрузки результатов (2 секунды)

#### Шаг 3: Прокрутка для загрузки результатов

```python
# Прокручиваем список результатов вниз
# Google Maps подгружает результаты динамически
while results_loaded < max_results:
    scroll_to_load_more()
    wait_for_new_results()
```

#### Шаг 4: Извлечение данных из HTML

Ищем элементы на странице по CSS селекторам:

**Название бизнеса:**

```python
selector = 'div[role="button"] span'
name = element.inner_text()
```

**Адрес:**

```python
selectors = [
    'span[aria-label*="Address"]',
    'div[data-value="Address"]'
]
```

**Телефон:**

```python
# Ищем в тексте элемента или в ссылке tel:
phone_pattern = r'\+?\d{1,4}[\s\-]?\d{1,4}[\s\-]?\d{1,9}'
```

**Рейтинг:**

```python
selector = 'span[aria-label*="stars"]'
# Извлекаем число из "4.5 stars"
```

**Веб-сайт:**

```python
# Ищем ссылку на сайт в элементе
website = element.get_attribute('href')
```

#### Шаг 5: Очистка и нормализация данных

- Удаляем лишние пробелы
- Нормализуем адреса Праги
- Форматируем телефоны в чешский формат (+420)

**Код:** `utils/lead_generation/google_maps_scraper.py`

---

## Текущая ситуация

### Что работает сейчас

- ✅ Браузерный скрапер (Playwright) - **РАБОТАЕТ БЕЗ API**
- ✅ Сохранение в Excel
- ✅ Логирование

### Что НЕ работает

- ❌ Google Maps API - Places API не включен
- ❌ MCP сервер - не настроен

---

## Как использовать браузерный скрапер

### Вариант 1: Через альтернативный скрипт

```powershell
cd c:\Users\-\Desktop\MVP\research_results
C:\Python312\python.exe scripts\prague_alternative_search.py --categories kadeřnictví kosmetika --max-per-category 15
```

### Вариант 2: Через коллектор с включенным скрапером

```powershell
# Установите переменную окружения
$env:LEAD_GENERATION_USE_SCRAPER="true"
$env:LEAD_GENERATION_USE_API="false"

C:\Python312\python.exe scripts\collect_prague_businesses.py
```

---

## Преимущества и недостатки

### Браузерный скрапер

**✅ Преимущества:**

- Не требует API ключа
- Бесплатно
- Работает как обычный пользователь
- Может получить больше данных (если они видны на странице)

**❌ Недостатки:**

- Медленнее (нужно загружать страницы)
- Может быть заблокирован Google (rate limiting)
- Зависит от структуры HTML (может сломаться при изменении)
- Требует больше ресурсов (браузер)

### Google Maps API

**✅ Преимущества:**

- Быстро
- Надежно
- Структурированные данные
- Официальный способ

**❌ Недостатки:**

- Требует API ключ
- Нужно включить Places API
- Платно после бесплатного лимита

---

## Что можно улучшить

1. **Добавить другие источники:**
   - Seznam.cz (чешский поисковик)
   - Firmy.cz (каталог компаний)
   - Yelp
   - Foursquare

2. **Улучшить извлечение данных:**
   - Более точные CSS селекторы
   - Обработка разных форматов страниц
   - Извлечение email с сайтов бизнесов

3. **Добавить обогащение данных:**
   - Поиск владельцев через ARES (чешский реестр)
   - Поиск через Obchodní rejstřík
   - Извлечение email с веб-сайтов

---

## Текущий процесс поиска

```
1. Запрос: "kadeřnictví Prague"
   ↓
2. Открытие: https://www.google.com/maps/search/kadeřnictví+Prague
   ↓
3. Загрузка страницы (2 сек)
   ↓
4. Поиск элементов: div[role="article"]
   ↓
5. Извлечение данных из каждого элемента:
   - Название
   - Адрес
   - Телефон
   - Рейтинг
   ↓
6. Прокрутка для загрузки больше результатов
   ↓
7. Повтор шагов 4-6 пока не наберем нужное количество
   ↓
8. Сохранение в Excel
```

---

## Проблемы и решения

### Проблема: Не находит результаты

**Причины:**

- Google изменил структуру HTML
- Блокировка от Google (слишком много запросов)
- Неправильные CSS селекторы

**Решение:**

- Обновить селекторы
- Добавить задержки между запросами
- Использовать разные User-Agent

### Проблема: Медленно работает

**Причина:**

- Нужно загружать каждую страницу
- Прокрутка для загрузки результатов

**Решение:**

- Уменьшить количество результатов
- Использовать параллельные запросы (осторожно!)
- Кэшировать результаты
